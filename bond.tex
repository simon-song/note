\chapter{Bonds}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Day count conventions}
Day count convention is used to calculate the number of days and the year 
fraction between two dates $T_1$ and $T_2$. It is crucial for calculating
interest payments of bonds and other interest rate products.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Actual/365}

\begin{align}
  Days(T_1,T_2) &= T_2 - T_1, \notag \\
  YF(T_1,T_2) &= \frac{Days(T_1,T_2)}{365}.
\end{align}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Actual/365 NoLeap}
Under this day count convention, any leap day (February 29th) between dates 
$T_1$ and $T_2$ will be ignored.

\begin{align}
  %Days(T_1,T_2) &= 
  %  \begin{cases}
  %    T_2 - T_1 - 1, & \text{if leap day (Feb 29) falls in} [T_1,T_2] \\
  %    T_2 - T_1, & otherwise,
  %  \end{cases} \notag \\
  Days(T_1,T_2) &= T_2 - T_1 - NumberOfLeapDays(T_1,T_2), \notag \\
  YF(T_1,T_2) &= \frac{Days(T_1,T_2)}{365}.
\end{align}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Actual/360}

\begin{align}
  Days(T_1,T_2) &= T_2 - T_1, \notag \\
  YF(T_1,T_2) &= \frac{Days(T_1,T_2)}{360}.
\end{align}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Actual/366}

\begin{align}
  Days(T_1,T_2) &= T_2 - T_1, \notag \\
  YF(T_1,T_2) &= \frac{Days(T_1,T_2)}{366}.
\end{align}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Actual/Actual ICMA}
Under the Actual/Actual ICMA convention, the year fraction between dates $T_1$
and $T_2$ given two reference dates $T_3$ and $T_4$, is given by:

\begin{align}
  Days(T_1,T_2) &= T_2 - T_1, \notag \\
  YF(T_1,T_2) &= \frac{Days(T_1,T_2)}{f \times Days(T_3, T_4)},
\end{align}
here $f$ is the payment frequency. If $f$ is not specified, it can be estimated
by
\begin{equation}
  f = \frac{12.0}{Integer(0.5 + 12 * (T_2 - T_1) / 365.0)}.
\end{equation}

If reference dates $T_3$ and $T_4$ are not given, we can usually set $T_3=T_1$
and $T_4=T_2$, and the year fraction formula becomes
\begin{equation}
  YF(T_1,T_2) = \frac{Days(T_1,T_2)}{f \times Days(T_1, T_2)}
              = \frac{1}{f}.
\end{equation}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Actual/Actual ISDA}

\begin{align}
  Days(T_1,T_2) &= T_2 - T_1, \notag \\
  YF(T_1,T_2) &= \frac{\text{Days not in leap year}}{365}
                 +\frac{\text{Days in leap year}}{366}.
\end{align}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{30/360}

Under the 30/360 convention, each month is treated to have 30 days, and each
year 360 days. To calculate the number of days between two dates $T_1$
(represented by day $D_1$, month $M_1$, year $Y_1$) and $T_2$
(represented by day $D_2$, month $M_2$, year $Y_2$), the following steps must be
performed:

\begin{enumerate}
  \item If $D_1=31$, set $D_1=30$;
  \item If $D_1=30$ and $D_2=31$, set $D_2=30$.
  \item $Days(T_1,T_2) = (D_2 - D_1) + 30 * (M_2 - M_1) + 360 * (Y_2 - Y_1)$.
\end{enumerate}

And the year fraction is given by
\begin{equation}
  YF(T_1,T_2) = \frac{Days(T_1,T_2)}{360}.
\end{equation}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Bond calculation}

A bond is a type of security under whith the issuer owes the holder a debt, and
is obliged to repay the principal of the bond at the maturity date, as well as a
series of interest over a specified series of dates.

%A coupon bond is a contract that pays at dates 
%$\{t_1,t_2,\cdots,t_{n}\}$ the amounts of $\{cf_1,cf_2,\cdots,cf_n\}$. 


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{figure}
  \begin{tikzpicture}[scale=0.9]
    \draw (-3.5,0) -- (2.8,0);
    \drawbreakright{2.8}{0}
    \drawbreakleft{4.2}{0}
    \draw (4.2,0) -- (9.3,0);
    \draw (-2,0) node[below] {$t_0$} -- (-2,0.2);

    \draw [->, >=triangle 90] 
      (0,0) node[below] {$t_1$} -- (0,2) node[above] {$cf_1$} ;
    \draw [->, >=triangle 90] 
      (2,0) node[below] {$t_2$} -- (2,2) node[above] {$cf_2$} ;
    \draw [->, >=triangle 90] 
      (5,0) node[below] {$t_{n-1}$} -- (5,2) node[above] {$cf_{n-1}$} ;
    \draw [->, >=triangle 90] 
      (7,0) node[below] {$t_{n}$} -- (7,3) node[above] {$cf_{n}$} ;
  \end{tikzpicture} 
  \caption{A prototypical coupon bond pays at dates
           $\{t_1,t_2,\cdots,t_{n}\}$ the fixed amounts of 
           $\{cf_1,cf_2,\cdots,cf_n\}$.}
\end{figure}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Notations}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{table*}
%\caption{Notations}
\begin{tabular}{r | l}
\hline\hline
$t_i$ & accrual dates \\
$[t_{i-1},t_{i}]$ & i-th accrual period \\
$N_i$  & starting notional for the i-th accrual period \\
$c_i$  & coupon for the i-th accrual period \\
$cf_i$ & cashflow for the i-th accrual period, paid at $t_i$ \\
$cf_i^{interest}$ & interest cashflow for the i-th accrual period \\
$f$    & payment frequency \\
$Days(t,s)$ & number of days between dates t and s (given day count convention)\\
$YF(t,s)$   & year fraction between dates t and s (given day count convention)\\
$AI$   & accrued interest \\
$YTM$  & yield to maturity \\
\hline
\end{tabular}
\end{table*}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Cashflows}

The cashflows of a coupon-bearing bond can be divided into interest cashflows
and principal cashflows. The interest cashflow of accrued period $[t_{i-1},t_i]$ 
is 
\begin{equation}
 cf_i^{interest} = N_i\cdot c_i \cdot YF(t_{i-1},t_{i}).
\end{equation}
The notional is usually paid in full at 
expiry, though they are some bonds with principal payment before the expiry.
%Typically the cashflows are defined as $c_i=N\delta_i K$ for $i<n$, and 
%$c_n=N\delta_n K+N$ where $K$ is a fixed coupon rate, $N$ is the face value,
%and $\delta_j$ be the year fraction between dates $T_{j-1}$ and $T_{j}$,

For discount bonds, there is no interest cashflows, but one principal payment of
the full notional at expiry.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Dirty price and clean price}

Bonds are often quoted in two different prices: dirty price and clean price,
the relationship between these two prices is
\begin{equation}
  P_{dirty} = P_{clean} + AI,
\end{equation}
where $AI$ is the accrued interest at the calculation date.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Accrued interest}
Suppose that the calculation date $t$ falls in the accrual period
$[t_{i-1},t_{i}]$, the accrued interest can be calculated by:
\begin{equation}
  %AI = \frac{N_i \cdot c_i}{f} \frac{ Days(t_i,t) }{Days(t_i,t_{i+1})}, 
  AI = cf_i^{interest} \frac{ Days(t_{i-1},t) }{Days(t_{i-1},t_{i})}, 
\end{equation}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Present value}
Bond price is calculated by discounting all future cashflows:
\begin{equation}
  PV_t = \sum_{t_i>t} cf_i \times DF_i,
\end{equation}
where the discount factor at time $t_i$ is given by:
\[
  DF_i = \exp(-r_t(t_i)\times (t_i-t)).
\]


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Yield to maturity}

In practice, bonds are often quoted in YTM (yield to maturity) rather than in
price. Basically, when cashflows are discounted using YTM, the present value 
equals to the market dirty price.

If the calculation date falls in the last accrual period $[t_{n-1},t_n]$, and
the remaining term is shorter than 1 year, the present value can be calculated 
from $YTM$ by simple compounding:
\begin{equation}
  PV_t = \frac{cf_n}{ 1+ YTM \times YF(t,t_i) },
\end{equation}

otherwise we have
\begin{equation}
  PV_t = \sum_{t_i>t} \frac{cf_i}{ (1+YTM/f)^{f\times YF(t,t_i)} }
\end{equation}

YTM may be solved from dirty price using a root-finding algorithm such as
Brent's method. 

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Yield to option}

Certain bonds may have call/put options embedded. For these bonds, we can 
also calculate the yield to option, defined as the yield if the cashflow stop at
the option exercise date. The calculation method is similar to that of
calculating YTM.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Macaulay Duration}
Macaulay duration is the weighted average duration of (remaining) cash flows,
wherein the remaining time of each cash flow is weighted by the present value of
the corresponding cash flow:

\begin{equation}
  Duration_{mac} = \frac{\sum_{t_i>t} YF(t,t_i)\times PV_i}
                        {\sum_{t_i>t} PV_i},
\end{equation}
where $PV_i$ is the present value of the $i$-th cash flow.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Modified Duration}
In contrast to Macaulay duration, modified duration is a price senstivity
measure, defined as the percentage derivative of price with respect to yield:

\begin{equation}
  Duration_{mod} = -\frac{1}{PV} \frac{\Delta (PV)}{\Delta Y}
    = \frac{PV(Y-\Delta Y) - PV(Y+\Delta Y)}
                        {(PV(Y-\Delta Y) + PV(Y+\Delta Y)) \times \Delta Y}.
\end{equation}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Convexity}
Bond convexity is a measure of the nonlinear relationship of bond prices to
changes in yield, being the second derivative of the bond price with respect to
yield:

\begin{equation}
  Convexity  
    = \frac{PV(Y-\Delta Y) + PV(Y+\Delta Y) - 2PV}{PV \times \Delta Y^2}.
\end{equation}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Interpolation methods}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Piecewise linear}

TODO



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Interpolating cubic splines}

\paragraph{Input:} a set of ordered $x, y$ coordinates
%\footnote{In this
%    document we start with index 1 which differs from C-convention
%    where indices start with 0. E.g.\ in this document $x_1$ equals to
%\code{x[0]} in code, $a_1=$ \code{a[0]}, $c_n=$ \code{c[n-1]}, etc.}
\begin{equation*}
\set{(x_1,y_1),\dots,(x_n,y_n)},\quad \text{with } x_1 < x_2 < \dots < x_n.
\end{equation*}
\paragraph{Output:} a piecewise cubic function
\begin{equation}
\begin{aligned}
    f(x) & = \begin{cases}
            f_0(x), & x<x_1,\\
            f_1(x), & x\in[x_1,x_2),\\
            \dots  \\
            f_{n-1}(x), & x\in[x_{n-1},x_n), \\
            f_{n}(x), & x\geq x_n. \\
            \end{cases} \\
            f_0(x)  & = a_1 + b_1 (x-x_1) + c_0 (x-x_1)^2, & x<x_1,\\
            f_i(x)  & = a_i + b_i (x-x_i) + c_i (x-x_i)^2 + d_i (x-x_i)^3, &
            x\in[x_i, x_{i+1}),\\
                f_n(x)  & = a_n + b_n (x-x_n) + c_n (x-x_n)^2, & x\geq x_n,
\end{aligned}
\end{equation}

\setlength{\unitlength}{1.0cm}
\begin{picture}(15,2)(0,-2)

 \put(0,-1.0){\line(1,0){6}}
 \put(8,-1.0){\line(1,0){5}}

 \put(1,-0.7){\makebox(0,0){$f_0$}}
 \put(2,-0.9){\line(0,-1){0.2}}
 \put(2,-1.4){\makebox(0,0){$x_1$}}

 \put(2.5,-0.7){\makebox(0,0){$f_1$}}
 \put(3,-0.9){\line(0,-1){0.2}}
 \put(3,-1.4){\makebox(0,0){$x_2$}}

 \put(3,-1.1){\vector(1,0){2}}
 \put(5,-1.1){\vector(-1,0){2}}
 \put(4,-1.4){\makebox(0,0){$h_2$}}

 \put(4,-0.7){\makebox(0,0){$f_2$}}
 \put(5,-0.9){\line(0,-1){0.2}}
 \put(5,-1.4){\makebox(0,0){$x_3$}}

 \put(9.5,-0.9){\line(0,-1){0.2}}
 \put(9.5,-1.4){\makebox(0,0){$x_{n-1}$}}

 \put(10.25,-0.7){\makebox(0,0){$f_{n-1}$}}
 \put(11,-0.9){\line(0,-1){0.2}}
 \put(11,-1.4){\makebox(0,0){$x_n$}}
 \put(12,-0.7){\makebox(0,0){$f_n$}}


\end{picture}

which satisfies
\begin{itemize}
   \item $f(x_i) = y_i$, i.e.\ $f$ interpolates all points (implies $a_i=y_i$),
   \item $f\in\Co^1$, i.e.\ is continuously differentiable.
\end{itemize}
More conditions will be imposed to specify $f$ uniquely but this
depends on the type of spline as described below.
Note, the derivatives of $f_i$ are given by
\begin{equation*}
\begin{split}
  f'_i(x)    & = 3 d_i (x-x_i)^2 + 2 c_i (x-x_i) + b_i,\\
  f''_i(x)   & = 6 d_i (x-x_i)+  2 c_i.\\
\end{split}
\end{equation*}
We also define $h_i:=x_{i+1}-x_i$, $i\in\set{1,\dots, n-1}$.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Cubic $\Co^2$ splines}
They are defined by
\begin{itemize}
   \item $f(x_i) = y_i$, i.e.\ $f$ interpolates all points,
   \item $f\in\Co^2$, i.e.\ $f$ is twice continuously differentiable.
\end{itemize}
In detail this means:
\begin{equation*}
\begin{aligned}
   \text{1) interpolates points: } f_i(x_i) & = y_i: &
    a_i & = y_i,\\
   \text{2) continuous } f\in\Co^0 \text{: } f_i(x_{i+1}) & =y_{i+1}: &
	d_i h_i^3 + c_i h_i^2 + b_i h_i & = y_{i+1}-y_i,\\
  \text{3) differentiable }f\in\Co^1 \text{: } f'_{i-1}(x_i) & =
    f'_i(x_i): &
    3 d_{i-1} h_{i-1}^2 + 2 c_{i-1} h_{i-1} + b_{i-1} & = b_i,\\
   \text{4) twice differentiable }f\in\Co^2 \text{: } f''_i(x_{i+1}) & =
    f''_{i+1}(x_{i+1}): &
    6 d_i h_i + 2 c_i & = 2 c_{i+1},\\
\end{aligned}
\end{equation*}
Solving for $d_i$ in the 4th condition ($f''$ continuous) gives
\begin{equation*}
    f\in\Co^2:\, d_i  =\frac{c_{i+1}-c_i}{3 h_i}.
\end{equation*}
Inserting this into the 2nd condition ($f$ continuous) and
solving for $b_i$ gives
\begin{equation*}
    f\in\Co^0:\, b_i  = \frac{y_{i+1}-y_i}{h_i} - \frac{1}{3} (2 c_i + c_{i+1}) h_i.
\end{equation*}
Finally, inserting these two equalities into the 3rd condition
($f'$ continuous) gives a linear equation system for $c$:
\begin{equation}
\label{eq:cubic_c2_spline_coeffs}
\boxed{
\begin{aligned}
 \frac{1}{3} h_{i-1} c_{i-1} + \frac{2}{3} (h_{i-1}+h_i) c_i
 + \frac{1}{3} h_i c_{i+1}   & =
 \frac{y_{i+1}-y_i}{h_i} -  \frac{y_i-y_{i-1}}{h_{i-1}},
 & i\in\set{2,\dots,n-1},\\
 d_i & =\frac{c_{i+1}-c_i}{3 h_i}, & i\in\set{1,\dots,n-1},\\
  b_i & = \frac{y_{i+1}-y_i}{h_i} - \frac{1}{3} (2 c_i + c_{i+1}) h_i,
 & i\in\set{1,\dots,n-1}.
\end{aligned}
}
\end{equation}

%\subsubsection*{Boundary conditions}
Second order conditions give immediate equations for $c_1$ and $c_n$:
\begin{equation*}
\begin{aligned}
    f''(x_1)&=\gamma_1: & c_0=c_1 & = \frac{\gamma_1}{2},\\
    f''(x_n)&=\gamma_n: & c_n & = \frac{\gamma_n}{2}.\\
\end{aligned}
\end{equation*}
First order conditions give immediate relationships for $b_1$ and $b_n$
which need to be translated to conditions for $c$:
\begin{equation*}
\begin{aligned}
    f'(x_1)&=\delta_1: & b_1&=\delta_1 \follows&
        \frac{2}{3}h_1 c_1 +\frac{1}{3}h_1 c_2
        & = \frac{y_2-y_1}{h_1} -\delta_1,\\
    f'(x_n)&=\delta_n: & b_n&=\delta_n \follows&
        \frac{1}{3}h_{n-1} c_{n-1} +\frac{2}{3}h_{n-1} c_n
        & = \delta_n - \frac{y_n-y_{n-1}}{h_{n-1}}.\\
\end{aligned}
\end{equation*}
The equation for the left boundary condition follows directly by inserting
$b_1=\delta_1$ into the third equation of \eqref{eq:cubic_c2_spline_coeffs}.
The equation for the right boundary condition follows from the
differentiability condition $f'_{n-1}(x_n)  = f'_n(x_n)$, replacing
$b_n$ by $\delta_n$ and replacing $b_{n-1}$ and $d_{n-1}$ by the relations
in Equation~\eqref{eq:cubic_c2_spline_coeffs}.

The not-a-knot condition, i.e.\ the continuity of the third derivatives
at the two outer segments, gives $d_1=d_2$ and $d_{n-2}=d_{n-1}$:
\begin{equation*}
\begin{aligned}
    f_1'''(x_2)&=f_2'''(x_2): & d_1&=d_2 \follows&
    -h_2 c_1 + (h_1+h_2) c_2 - h_1 c_3 & = 0,\\
    f_{n-2}'''(x_{n-1})&=f_{n-1}'''(x_{n-1}): & d_{n-2}&=d_{n-1}\follows&
    -h_{n-1} c_{n-2} + (h_{n-2}+h_{n-1}) c_{n-1} - h_{n-2} c_n & = 0.
\end{aligned}
\end{equation*}



In all cases, $d_n$ and $b_n$ are then determined by:
\begin{equation*}
\begin{aligned}
    \text{quadratic extrapolation:} & & d_n & = 0,\\
    f'_{n-1}(x_n)  = f'_n(x_n): & & b_n & = 3 d_{n-1} h_{n-1}^2 + 2 c_{n-1} h_{n-1} + b_{n-1}.
\end{aligned}
\end{equation*}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Hermite $\Co^1$ splines}
They are defined by
\begin{itemize}
   \item $f(x_i) = y_i$, i.e.\ $f$ interpolates all points,
   \item $f\in\Co^1$, i.e.\ $f$ is continuously differentiable,
   \item $f'(x_i) = \delta_i$, i.e.\ derivatives are specified at each inner
       point, e.g.\ by three point finite differences
       \begin{equation*}
       \delta_i=-\frac{h_i}{h_{i-1}(h_{i-1} + h_i)} y_{i-1}
           + \frac{h_i-h_{i-1}}{h_{i-1} h_i} y_i
           + \frac{h_{i-1}}{h_i(h_{i-1} + h_i)} y_{i+1}.
       \end{equation*}
\end{itemize}
In detail this means:
\begin{equation*}
\begin{aligned}
    \text{1) interpolates points: } f_i(x_i) & = y_i: &
    a_i & = y_i,\\
    \text{2) prescribed derivative: } f'_i(x_i) & = \delta_i: &
    b_i & = \delta_i,\\
    \text{3) continuous } f\in\Co^0 \text{: } f_i(x_{i+1}) & =y_{i+1}: &
	d_i h_i^3 + c_i h_i^2 + b_i h_i & = y_{i+1}-y_i,\\
    \text{4) differentiable }f\in\Co^1 \text{: } f'_i(x_{i+1}) & =\delta_{i+1}: &
    3 d_i h_i^2 + 2 c_i h_i  & = \delta_{i+1}-\delta_i,\\
\end{aligned}
\end{equation*}
which can be solved to obtain
\begin{equation}
\label{eq:hermite_spline_coeffs}
\boxed{
\begin{aligned}
  \text{1) } a_i & =  y_i, \\
  \text{2) } b_i & =  \delta_i, \\
  \text{3,4) } c_i & = -\frac{2 b_i+b_{i+1}}{h_i}+3\frac{a_{i+1}-a_i}{h_i^2}
    & = -\frac{2\delta_i+\delta_{i+1}}{h_i} + 3 \frac{y_{i+1}-y_i}{h_i^2},
        \quad i\in\set{1,\dots,n-1},\\
  \text{4) } d_i & = -\frac{2 c_i}{3 h_i}+\frac{b_{i+1}-b_i}{3 h_i^2}
    & = \frac{\delta_i+\delta_{i+1}}{h_i^2}-2\frac{y_{i+1}-y_i}{h_i^3},
        \quad i\in\set{1,\dots,n-1}.
\end{aligned}
}
\end{equation}

%\subsubsection*{Boundary conditions}
First order conditions are trivial:
\begin{equation*}
\begin{aligned}
    f'(x_1)&=\delta_1: & b_1 & = \delta_1,\, c_0 = 0,\\
    f'(x_n)&=\delta_n: & b_n & = \delta_n,\, c_n = 0.
\end{aligned}
\end{equation*}

Second order conditions imply a value for $c$ but we can re-express
this in terms of $b$:
\begin{equation*}
\begin{aligned}
    f''(x_1)&=\gamma_1: & c_0 = c_1 &= \frac{1}{2}\gamma_1 \equivalent
        b_1 = \frac{1}{2}\left(-b_2 -\frac{\gamma}{2} h_1
            + 3 \frac{y_2-y_1}{h_1}\right),\\
    f_n''(x_n)&=\gamma_n: & c_n &= \frac{1}{2}\gamma_n,\\
            f_{n-1}''(x_n)&=\gamma_n: & 6 d_{n-1}h_{n-1} + 2 c_{n-1} &= \frac{1}{2}\gamma_n \equivalent
            b_n = \frac{1}{2}\left(-b_{n-1} +\frac{\gamma}{2} h_{n-1}
            + 3 \frac{y_n-y_{n-1}}{h_{n-1}}\right).\\
\end{aligned}
\end{equation*}

The not-a-knot contition gives $d_1=d_2$ and $d_{n-2}=d_{n-1}$ and
re-expressing in terms of $b$ yields:
\begin{equation*}
\begin{aligned}
    f_1'''(x_2)&=f_2'''(x_2): & d_1&=d_2 \equivalent &
    b_1 & = -b_2+2\frac{y_2-y_1}{h_1}+\frac{h_1^2}{h_2^2}
        \left(b_2+b_3-2\frac{y_3-y_2}{h_2}\right),\\
    f_{n-2}'''(x_{n-1})&=f_{n-1}'''(x_{n-1}): & d_{n-2}&=d_{n-1}\equivalent&
    b_n & = -b_{n-1}+2\frac{y_n-y_{n-1}}{h_{n-1}}\\
        & & & & & +\frac{h_{n-1}^2}{h_{n-2}^2}
        \left(b_{n-2}+b_{n-1}-2\frac{y_{n-1}-y_{n-2}}{h_{n-2}}\right).
\end{aligned}
\end{equation*}
To determine a value for $c_n$ we additionally impose second order
continuity at the boundary:
\begin{equation*}
    f_{n-1}''(x_n)=f_n''(x_n): \, c_n =3d_{n-1}h_{n-1}+c_{n-1} \equivalent\,
        c_n=\frac{b_{n-1}+2 b_n}{h_{n-1}}-3\frac{y_n-y_{n-1}}{h_{n-1}^2}.
\end{equation*}

